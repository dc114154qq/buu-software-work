<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¦æƒ… - èƒ¡åŒå¯¼è§ˆ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="detail-header">
        <img id="d-img" class="detail-img" src="" alt="æ™¯ç‚¹å›¾ç‰‡" onclick="openModal()" onerror="this.src='https://via.placeholder.com/400x200?text=No+Image';this.style.cursor='default';">
        <div id="d-cover-text" style="position:absolute; bottom:10px; left:15px; color:white; font-size:1.5rem; text-shadow:0 2px 4px rgba(0,0,0,0.5); pointer-events:none;"></div>
    </div>
    
    <div class="detail-body">
        <a href="javascript:history.back()" style="color:var(--primary-color); font-weight:bold; display:block; margin-bottom:15px; text-decoration:none;">
            â† è¿”å›ä¸Šä¸€é¡µ
        </a>
        
        <h2 id="d-name" style="margin-top:0;">åŠ è½½ä¸­...</h2>
        <div style="margin-bottom:15px;">
            <span class="tag" id="d-type"></span>
            <span style="color:#ff9f43; font-weight:bold; margin-left:10px;" id="d-rating"></span>
            <span style="color:#636e72; font-size:0.9rem; margin-left:10px;" id="d-price"></span>
        </div>
        
        <p id="d-address" style="color:#666; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px; display:flex; align-items:center;">
            ğŸ“ <span style="margin-left:5px">åœ°å€åŠ è½½ä¸­...</span>
        </p>
        
        <h4>ğŸ’° ä¼˜æƒ  / è¯¦ç»†ä¿¡æ¯</h4>
        <div id="d-offers" style="margin-bottom:20px;"></div>

        <div id="poi-booking-section" style="display:none; background:#fff8e1; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #ffecb3;">
            <h4 style="margin-top:0; color:#f57f17; display:flex; align-items:center;">
                ğŸ“… æ™¯ç‚¹/ç¾é£Ÿé¢„çº¦ 
            </h4>
            <div id="poi-booking-form" style="display:flex; flex-direction:column; gap:12px;">
                <div>
                    <label style="font-size:0.9rem; color:#f57f17; display:block; margin-bottom:4px;">ğŸ—“ï¸ é¢„çº¦æ—¶é—´ï¼š</label>
                    <input type="datetime-local" id="poi-time-input" style="width:100%; padding:10px; border:1px solid #ffe082; border-radius:6px; box-sizing:border-box; font-family:inherit;">
                </div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label style="font-size:0.9rem; color:#f57f17; display:block; margin-bottom:4px;">ğŸ‘¤ å§“åï¼š</label>
                        <input type="text" id="user-name" placeholder="æ‚¨çš„ç§°å‘¼" style="width:100%; padding:10px; border:1px solid #ffe082; border-radius:6px;">
                    </div>
                    <div style="flex:1">
                        <label style="font-size:0.9rem; color:#f57f17; display:block; margin-bottom:4px;">ğŸ‘¥ äººæ•°ï¼š</label>
                        <input type="number" id="user-people" value="2" min="1" style="width:100%; padding:10px; border:1px solid #ffe082; border-radius:6px;">
                    </div>
                </div>
                <div>
                    <label style="font-size:0.9rem; color:#f57f17; display:block; margin-bottom:4px;">ğŸ“ è”ç³»ç”µè¯ï¼š</label>
                    <input type="tel" id="user-phone" placeholder="æ¥æ”¶çŸ­ä¿¡é€šçŸ¥" style="width:100%; padding:10px; border:1px solid #ffe082; border-radius:6px;">
                </div>
                <button onclick="handlePoiBooking()" id="poi-submit-btn" style="padding:12px 20px; background:#ff9f43; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; box-shadow:0 2px 5px rgba(255, 159, 67, 0.4); margin-top:5px;">
                    æäº¤é¢„çº¦ä¿¡æ¯
                </button>
            </div>
        </div>

        <div id="booking-section" style="display:none; background:#f0f9eb; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #c3e6cb;">
            <h4 style="margin-top:0; color:#2e7d32; display:flex; align-items:center;">
                ğŸ…¿ï¸ åœ¨çº¿é¢„çº¦è½¦ä½ 
            </h4>
            
            <div id="booking-status" style="margin-bottom:15px; font-weight:bold; padding-bottom:10px; border-bottom:1px dashed #aadec2;">
                æ­£åœ¨åŒæ­¥è½¦ä½æ•°æ®...
            </div>
            
            <div id="booking-form" style="display:flex; flex-direction:column; gap:12px;">
                <div>
                    <label style="font-size:0.9rem; color:#2e7d32; display:block; margin-bottom:4px;">ğŸ“… é¢„è®¡å…¥åœºæ—¶é—´ï¼š</label>
                    <input type="datetime-local" id="time-input" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-family:inherit;">
                </div>
                <div>
                    <label style="font-size:0.9rem; color:#2e7d32; display:block; margin-bottom:4px;">ğŸš— è½¦ç‰Œå·ç ï¼š</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="plate-input" placeholder="ä¾‹ï¼šäº¬A88888" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:6px;">
                        <button onclick="handleParkBooking()" id="submit-btn" style="padding:10px 20px; background:#2e7d32; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; box-shadow:0 2px 5px rgba(46, 125, 50, 0.3);">
                            æäº¤é¢„çº¦
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <h4>ğŸ“ ç®€ä»‹ / è®¾æ–½</h4>
        <div id="d-desc" style="color:#555; font-size:0.9rem; line-height:1.6;"></div>
    </div>

    <div id="imgModal" class="modal" onclick="closeModal()">
        <span class="close-btn">&times;</span>
        <img class="modal-content" id="img01">
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é¡µ</a>
        <a href="pois.html" class="nav-item"><span class="nav-icon">ğŸœ</span>æ™¯ç‚¹ç¾é£Ÿ</a>
        <a href="stays.html" class="nav-item"><span class="nav-icon">ğŸ›ï¸</span>é…’åº—ä½å®¿</a>
        <a href="parks.html" class="nav-item"><span class="nav-icon">ğŸ…¿ï¸</span>åœè½¦åœº</a>
        <a href="route.html" class="nav-item"><span class="nav-icon">ğŸ—ºï¸</span>è·¯çº¿</a>
    </nav>

    <script>
        let currentParkItem = null;
        let serverBookings = []; 
        const params = new URLSearchParams(window.location.search);
        const targetId = params.get('id');

        // 1. åŠ è½½æ•°æ®
        Promise.all([
            fetch('./data.json').then(res => res.json()),
            fetch('./park.json').then(res => res.json())
        ]).then(([mainData, parkData]) => {
            renderPage(mainData, parkData);
            
            // 2. åŠ è½½é¢„çº¦å†å²ï¼ˆå¤±è´¥ä¸å½±å“é¡µé¢ï¼‰
            fetch('./bookings.json?t=' + Date.now())
                .then(res => res.ok ? res.json() : [])
                .then(data => {
                    serverBookings = Array.isArray(data) ? data : [];
                    updateBookingStatus();
                })
                .catch(() => { serverBookings = []; updateBookingStatus(); });

        }).catch(err => {
            console.error(err);
            document.querySelector('.detail-body').innerHTML = "<div style='padding:20px;text-align:center;color:red'>æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ data.json</div>";
        });

        function renderPage(mainData, parkData) {
            const parkList = Array.isArray(parkData) ? parkData : (parkData.pois || []);
            const allItems = [...(mainData.pois || []), ...(mainData.stays || []), ...parkList];

            const item = allItems.find(i => i.id === targetId);
            if(!item) {
                document.querySelector('.detail-body').innerHTML = "<div style='padding:20px;text-align:center'>âš ï¸ æœªæ‰¾åˆ°è¯¥é¡¹ç›®ä¿¡æ¯</div>";
                return;
            }
            currentParkItem = item; 

            // åŸºç¡€ä¿¡æ¯
            document.getElementById('d-name').innerText = item.name;
            document.getElementById('d-cover-text').innerText = item.name;
            document.getElementById('d-type').innerText = item.category || item.type || 'å…¶å®ƒ';
            document.getElementById('d-rating').innerText = item.rating ? `â˜… ${item.rating}` : '';
            const imgEl = document.getElementById('d-img');
            imgEl.src = (item.media && item.media.cover) ? item.media.cover : 'https://via.placeholder.com/400x300?text=No+Image';

            let priceDisplay = '';
            if (item.avgPricePerPersonCNY) priceDisplay = `Â¥${item.avgPricePerPersonCNY}/äºº`;
            else if (item.roomOffers && item.roomOffers.length) priceDisplay = `Â¥${item.roomOffers[0].priceCNY}èµ·`;
            else if (item.priceText) priceDisplay = item.priceText;
            document.getElementById('d-price').innerText = priceDisplay;
            
            const address = item.location ? item.location.address : (item.address || 'åœ°å€æœªçŸ¥');
            document.getElementById('d-address').innerHTML = `ğŸ“ <span style="margin-left:5px">${address}</span>`;

            // Offers
            const offersDiv = document.getElementById('d-offers');
            let html = '';
            if(item.deals && item.deals.length) item.deals.forEach(d => html += `<div class="deal-item">ğŸ·ï¸ ${d.title || d}</div>`);
            else if (item.roomOffers) item.roomOffers.forEach(r => html += `<div class="deal-item">ğŸ›ï¸ ${r.roomName} Â¥${r.priceCNY}</div>`);
            else if (item.parkingInfo) {
                html += `<div class="deal-item">ğŸš— æ€»è½¦ä½ï¼š${item.parkingInfo.totalSpaces || '-'}</div>`;
            } else html = "<div style='color:#999; padding:10px 0;'>æš‚æ— ä¼˜æƒ </div>";
            offersDiv.innerHTML = html;

            document.getElementById('d-desc').innerText = item.keywords ? item.keywords.join('ã€') : "æš‚æ— è¯¦ç»†æè¿°";

            // --- æ ¸å¿ƒä¿®å¤ï¼šå†³å®šæ˜¾ç¤ºå“ªä¸ªé¢„çº¦æ¡† ---
            const parkSection = document.getElementById('booking-section'); // ç»¿è‰²
            const poiSection = document.getElementById('poi-booking-section'); // é»„è‰²
            
            parkSection.style.display = 'none';
            poiSection.style.display = 'none';
            
            // å®½æ¾åˆ¤æ–­ï¼šåªè¦æ˜¯åœè½¦åœºï¼Œæˆ–è€…IDåŒ…å«'park'ï¼Œå°±æ˜¾ç¤ºç»¿è‰²æ¡†
            if (item.type === 'åœè½¦åœº' || (item.id && item.id.includes('park'))) {
                parkSection.style.display = 'block';
                initTimeInput('time-input');     
            } 
            // å®½æ¾åˆ¤æ–­ï¼šåªè¦æ˜¯é¤é¥®ã€æ™¯ç‚¹ã€ä½å®¿ï¼Œæˆ–è€…IDåŒ…å«'restaurant'/'scenic'ï¼Œå°±æ˜¾ç¤ºé»„è‰²æ¡†
            else if (['é¤é¥®', 'æ™¯ç‚¹', 'ä½å®¿'].includes(item.type) || item.id.includes('restaurant') || item.id.includes('scenic')) {
                poiSection.style.display = 'block';
                initTimeInput('poi-time-input');
            }
        }

        function initTimeInput(elementId) {
            const now = new Date();
            const tzOffset = now.getTimezoneOffset() * 60000; 
            const localISOTime = (new Date(now - tzOffset)).toISOString().slice(0, 16);
            const el = document.getElementById(elementId);
            if(el) { el.value = localISOTime; el.min = localISOTime; }
        }

        function updateBookingStatus() {
            if (!currentParkItem || !document.getElementById('booking-section').style.display === 'block') return;
            
            const total = parseInt(currentParkItem.parkingInfo?.totalSpaces) || 0;
            const occupied = serverBookings.filter(b => b.parkId === currentParkItem.id).length;
            const left = Math.max(0, total - occupied);

            document.getElementById('booking-status').innerHTML = 
                `<span style="color:${left>0?'#2e7d32':'#d63031'}">å‰©ä½™è½¦ä½ï¼š<b>${left}</b> / ${total}</span>`;
            
            const btn = document.getElementById('submit-btn');
            if(left <= 0) { btn.disabled = true; btn.innerText = "å·²æ»¡å‘˜"; btn.style.background = "#ccc"; }
            else { btn.disabled = false; btn.innerText = "æäº¤é¢„çº¦"; btn.style.background = "#2e7d32"; }
        }

        // --- åœè½¦åœºæäº¤ ---
        function handleParkBooking() {
            const plate = document.getElementById('plate-input').value.trim();
            const startTime = document.getElementById('time-input').value;
            if (!plate || !startTime) { alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼"); return; }
            submitData({ parkId: currentParkItem.id, plate, startTime }, 'submit-btn');
        }

        // --- æ™¯ç‚¹æäº¤ ---
        function handlePoiBooking() {
            const dateStr = document.getElementById('poi-time-input').value;
            const name = document.getElementById('user-name').value.trim();
            const phone = document.getElementById('user-phone').value.trim();
            const people = document.getElementById('user-people').value;
            if (!dateStr || !name || !phone) { alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼"); return; }
            submitData({ poiId: currentParkItem.id, poiName: currentParkItem.name, user: { name, phone }, people }, 'poi-submit-btn');
        }

        function submitData(payload, btnId) {
            const btn = document.getElementById(btnId);
            const oldText = btn.innerText;
            btn.innerText = "å¤„ç†ä¸­..."; btn.disabled = true;

            fetch('/api/book', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) { alert("âœ… " + data.message); location.reload(); }
                else { alert("âŒ " + data.message); }
            })
            .catch(err => alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¡®è®¤æœåŠ¡å™¨å·²å¯åŠ¨"))
            .finally(() => { btn.innerText = oldText; btn.disabled = false; });
        }

        function openModal() { document.getElementById('imgModal').style.display = "block"; document.getElementById("img01").src = document.getElementById('d-img').src; }
        function closeModal() { document.getElementById('imgModal').style.display = "none"; }
    </script>
</body>
</html>