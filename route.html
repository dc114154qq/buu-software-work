<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¯çº¿è§„åˆ’ - AIå‡çº§ç‰ˆ</title>
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="https://api.map.baidu.com/api?type=webgl&v=1.0&ak=iiS8DXGXwqzQr82HSDdIpX7YmcEf4zZu"></script>

    <style>
        /* --- å…¨å±€æ ·å¼ç»Ÿä¸€ --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-color: #d63031;
            --secondary-color: #ff9f43;
            --light-gray: #f5f5f5;
            --mid-gray: #e0e0e0;
            --dark-gray: #636e72;
            --radius: 10px;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        body {
            font-family: "Microsoft Yahei", sans-serif;
            color: #333;
            line-height: 1.7;
            background-color: #f9f9f9;
            padding-bottom: 70px;
        }
        a { text-decoration: none; color: inherit; }

        header {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 16px 0;
            font-size: 1.5rem;
            font-weight: 700;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* åœ°å›¾æ ·å¼ */
        #allmap {
            width: 100%;
            height: 350px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            border: 1px solid var(--mid-gray);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        /* éšè—ç™¾åº¦åœ°å›¾ç‰ˆæƒï¼Œä¿æŒæ•´æ´ */
        .BMap_cpyCtrl, .anchorBL { display: none; } 

        /* AI è¾“å…¥æ¡†å¡ç‰‡ */
        .ai-input-card {
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
            border: 1px solid #ffcccc;
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }
        .ai-textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ffcccc;
            border-radius: 8px;
            resize: none;
            margin-bottom: 10px;
            font-size: 0.9rem;
            outline: none;
        }
        .ai-textarea:focus { border-color: var(--primary-color); }
        
        .ai-btn {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.2s;
        }
        .ai-btn:active { opacity: 0.9; }

        .loading-spinner {
            display: inline-block;
            width: 12px; height: 12px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* æ ‡ç­¾é¡µ Tab */
        .tab-container {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 5px;
            margin-bottom: 15px;
            /* éšè—æ»šåŠ¨æ¡ */
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .tab-container::-webkit-scrollbar { display: none; }

        .tab-btn {
            background: white;
            border: 1px solid var(--mid-gray);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--dark-gray);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(214, 48, 49, 0.3);
        }

        /* è·¯çº¿ä»‹ç»ä¸æ—¶é—´è½´ */
        .route-desc-card {
            background: #fff0f0;
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
            font-size: 0.9rem;
            color: #555;
            box-shadow: var(--shadow);
        }

        .timeline-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
        }

        .timeline { list-style: none; padding: 0; }
        .timeline-item {
            padding-left: 25px;
            position: relative;
            margin-bottom: 25px;
        }
        .timeline-item:last-child { margin-bottom: 0; }
        
        /* æ—¶é—´è½´åœ†ç‚¹ */
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0; top: 5px;
            width: 10px; height: 10px;
            background: var(--primary-color);
            border-radius: 50%;
            box-shadow: 0 0 0 3px rgba(214, 48, 49, 0.2);
        }
        /* æ—¶é—´è½´è¿çº¿ */
        .timeline-item::after {
            content: '';
            position: absolute;
            left: 4px; top: 18px;
            width: 2px;
            height: calc(100% + 5px);
            background: #eee;
        }
        .timeline-item:last-child::after { display: none; }
    </style>
</head>
<body>
    <header><h1>è·¯çº¿è§„åˆ’</h1></header>

    <div class="container">
        <div class="ai-input-card">
            <h3 style="margin:0 0 10px 0; color:var(--primary-color); font-size:1.1rem;">ğŸ¤– AI æ™ºèƒ½å®šåˆ¶</h3>
            <textarea id="ai-prompt" class="ai-textarea" placeholder="è¯·è¾“å…¥æ‚¨çš„éœ€æ±‚ï¼Œä¾‹å¦‚ï¼š&#10;â€œå¸¦çˆ¶æ¯ç©ï¼Œæƒ³åƒçƒ¤é¸­ï¼Œä¸è¦å¤ªç´¯â€&#10;â€œç‰¹ç§å…µä¸€æ—¥æ¸¸ï¼Œæƒ³å»å¤©å®‰é—¨å’Œåšç‰©é¦†â€"></textarea>
            <button id="ai-btn" class="ai-btn" onclick="generateAIRoute()">
                âœ¨ ç”Ÿæˆæˆ‘çš„ä¸“å±è·¯çº¿
            </button>
            <div id="ai-error" style="color:red; font-size:0.8rem; margin-top:5px; display:none;"></div>
        </div>

        <div class="tab-container">
            <button class="tab-btn active" onclick="switchRoute('elder')">ğŸ‘´ é“¶å‘ä¼‘é—²</button>
            <button class="tab-btn" onclick="switchRoute('youth')">ğŸ“¸ é’å¹´æ‰“å¡</button>
            <button class="tab-btn" onclick="switchRoute('kids')">ğŸ‘¶ äº²å­ç ”å­¦</button>
            <button class="tab-btn" onclick="switchRoute('quick')">âš¡ æé€Ÿç²¾å</button>
            <button class="tab-btn" onclick="switchRoute('immersive')">ğŸµ æ·±åº¦æ²‰æµ¸</button>
            <button class="tab-btn" id="ai-tab-btn" onclick="switchRoute('ai-custom')" style="display:none;">ğŸ¤– ä¸“å±å®šåˆ¶</button>
        </div>

        <div id="allmap"></div>

        <div id="route-intro" class="route-desc-card">æ­£åœ¨è§„åˆ’è·¯çº¿æ•°æ®...</div>

        <div class="timeline-card">
            <ul class="timeline" id="route-container"></ul>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="index.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é¡µ</a>
        <a href="pois.html" class="nav-item"><span class="nav-icon">ğŸœ</span>æ™¯ç‚¹ç¾é£Ÿ</a>
        <a href="stays.html" class="nav-item"><span class="nav-icon">ğŸ›ï¸</span>é…’åº—ä½å®¿</a>
        <a href="parks.html" class="nav-item"><span class="nav-icon">ğŸ…¿ï¸</span>åœè½¦åœº</a>
        <a href="route.html" class="nav-item active"><span class="nav-icon">ğŸ—ºï¸</span>è·¯çº¿</a>
    </nav>

    <script>
        // å…¨å±€å˜é‡
        let map = null;
        let allItemsMap = {}; // æ•°æ®å­—å…¸ï¼š{ "poi-id": {data...} }
        let rawDataList = []; // ç”¨äºå‘é€ç»™AIçš„åŸå§‹æ•°æ®åˆ—è¡¨

        // --- 1. è·¯çº¿ç­–ç•¥é…ç½® ---
        const routeStrategies = {
            'elder': {
                desc: "å°‘èµ°å›å¤´è·¯ï¼Œä½“éªŒè€å­—å·ä¸ç»å…¸åœ°æ ‡ï¼Œå…¨ç¨‹å¹³ç¼“ï¼Œé€‚åˆé•¿è¾ˆã€‚",
                path: [
                    { id: "stay-hotel-005", time: "09:30", action: "å‡ºå‘", note: "å…¥ä½æ±‰åº­é…’åº—(å‰é—¨å¤§è¡—åº—)ï¼Œä½ç½®ä¾¿åˆ©" },
                    { id: "poi-restaurant-001", time: "11:30", action: "åˆé¤", note: "ç™¾å¹´å‰é—¨é“œé”…æ¶®è‚‰ï¼Œå£å‘³æ­£å®—è½¯çƒ‚" },
                    { id: "poi-scenic-002", time: "14:00", action: "æ¸¸è§ˆ", note: "å¤©å®‰é—¨å¹¿åœºï¼Œç»ä»°é›„ä¼Ÿå»ºç­‘" },
                    { id: "poi-restaurant-003", time: "17:30", action: "æ™šé¤", note: "å…¨èšå¾·çƒ¤é¸­ï¼Œå“å°å›½å®´çº§ç¾é£Ÿ" }
                ]
            },
            'youth': {
                desc: "ç‰¹ç§å…µæ‰“å¡è·¯çº¿ï¼é›†åˆç½‘çº¢æœºä½ä¸æ½®æµåœ°æ ‡ï¼Œéå¸¸å‡ºç‰‡ã€‚",
                path: [
                    { id: "stay-hotel-008", time: "08:00", action: "å‡ºå‘", note: "ä»æ¡”å­é…’åº—å‡ºå‘ï¼Œç¯å¢ƒæ—¶å°š" },
                    { id: "poi-scenic-002", time: "09:00", action: "æ‹ç…§", note: "å¤©å®‰é—¨å¹¿åœºæ‹æ‘„æ—¥å‡º/å‡æ——æ°›å›´" },
                    { id: "poi-restaurant-002", time: "11:30", action: "åˆé¤", note: "å››å­£æ°‘ç¦çƒ¤é¸­ï¼Œç»ç¾æ™¯è§‚ä½æ‰“å¡" },
                    { id: "poi-scenic-003", time: "14:30", action: "çœ‹å±•", note: "å›½å®¶åšç‰©é¦†ï¼Œæ‹æ‘„å†å²æ–‡ç‰©å¤§ç‰‡" }
                ]
            },
            'kids': {
                desc: "å¯“æ•™äºä¹ï¼Œç©ºé—´å¼€é˜”ï¼ŒåŒ…å«åšç‰©é¦†ä¸å…¬å›­ï¼Œå®‰å…¨ä¸”æœ‰è¶£ã€‚",
                path: [
                    { id: "stay-hotel-006", time: "09:00", action: "å‡ºå‘", note: "å…¨å­£é…’åº—(å¤©å›åº—)å‡ºå‘" },
                    { id: "poi-scenic-001", time: "09:30", action: "æ¸¸ç©", note: "å¤©å›å…¬å›­ï¼Œä½“éªŒå›éŸ³å£çš„å¥‡å¦™" },
                    { id: "poi-scenic-003", time: "13:30", action: "ç ”å­¦", note: "å›½å®¶åšç‰©é¦†ï¼Œäº†è§£å¤ä»£ä¸­å›½å†å²" },
                    { id: "poi-restaurant-003", time: "17:00", action: "æ™šé¤", note: "å…¨èšå¾·ï¼Œçœ‹ç‰‡é¸­å¸ˆå‚…ç°åœºè¡¨æ¼”" }
                ]
            },
            'quick': {
                desc: "2-3å°æ—¶æ¸¸è§ˆå‰é—¨æ ¸å¿ƒç²¾åï¼Œä¸èµ°å†¤æ‰è·¯ï¼Œé€‚åˆæ—¶é—´ç´§è¿«çš„æ¸¸å®¢ã€‚",
                path: [
                    { id: "stay-hotel-007", time: "10:00", action: "å‡ºå‘", note: "7å¤©ä¼˜å“(å¤©å®‰é—¨å¹¿åœºåº—)å‡ºå‘" },
                    { id: "poi-scenic-002", time: "10:30", action: "æ‰“å¡", note: "å¤©å®‰é—¨é‡‘æ°´æ¡¥ç•™å½±" },
                    { id: "poi-restaurant-002", time: "12:00", action: "å¿«åƒ", note: "å››å­£æ°‘ç¦(å¤§æ …æ åº—)å“å°çƒ¤é¸­" }
                ]
            },
            'immersive': {
                desc: "ä½åœ¨èƒ¡åŒé‡Œï¼Œåƒåœ¨èƒ¡åŒé‡Œï¼Œæ·±åº¦æ„Ÿå—è€åŒ—äº¬çš„æ…¢ç”Ÿæ´»ã€‚",
                path: [
                    { id: "stay-hotel-001", time: "10:00", action: "é†’æ¥", note: "é’äº‘é˜é…’åº—ï¼Œæ„Ÿå—ç™¾å¹´å†å²å»ºç­‘" },
                    { id: "poi-restaurant-001", time: "12:00", action: "åˆé¤", note: "ç™¾å¹´å‰é—¨é“œé”…æ¶®è‚‰ï¼Œåœ°é“çƒŸç«æ°”" },
                    { id: "poi-scenic-002", time: "15:00", action: "æ•£æ­¥", note: "æ­¥è¡Œè‡³å¤©å®‰é—¨ï¼Œæ„Ÿå—ä¸­è½´çº¿é­…åŠ›" }
                ]
            }
        };

        // --- 2. ç¨‹åºåˆå§‹åŒ– ---
        async function init() {
            try {
                const response = await fetch('./data.json');
                const data = await response.json();

                // å»ºç«‹ç´¢å¼• & å‡†å¤‡AIæ•°æ®åˆ—è¡¨
                rawDataList = [...(data.pois || []), ...(data.stays || [])];
                rawDataList.forEach(item => {
                    allItemsMap[item.id] = item;
                });

                initMap();
                switchRoute('elder');

            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", error);
                document.getElementById('route-intro').innerHTML = "âš ï¸ æ•°æ®åŠ è½½å¤±è´¥ã€‚";
            }
        }

        // --- 3. åˆå§‹åŒ–åœ°å›¾å®ä¾‹ ---
        function initMap() {
            map = new BMapGL.Map("allmap");
            const center = new BMapGL.Point(116.399, 39.900);
            map.centerAndZoom(center, 15);
            map.enableScrollWheelZoom(true);
        }

        // --- 4. åˆ‡æ¢è·¯çº¿ä¸»é€»è¾‘ ---
        function switchRoute(type) {
            // UI Tab é«˜äº®å¤„ç†
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            let btnIndex = ['elder', 'youth', 'kids', 'quick', 'immersive'].indexOf(type);
            if(btnIndex !== -1) {
                document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
            } else if (type === 'ai-custom') {
                const aiBtn = document.getElementById('ai-tab-btn');
                aiBtn.style.display = 'inline-block';
                aiBtn.classList.add('active');
            }

            const strategy = routeStrategies[type];
            if (!strategy) return;

            // æ¸²æŸ“æè¿°ä¸å†…å®¹
            document.getElementById('route-intro').innerHTML = `<strong>ğŸ’¡ è·¯çº¿ç‰¹è‰²ï¼š</strong>${strategy.desc}`;
            const timelineContainer = document.getElementById('route-container');
            timelineContainer.innerHTML = '';
            map.clearOverlays(); 

            const validPoints = [];
            strategy.path.forEach((step, index) => {
                const item = allItemsMap[step.id];
                if (!item) return;

                const address = item.location ? item.location.address : item.address;
                timelineContainer.innerHTML += `
                    <li class="timeline-item">
                        <div style="font-weight:bold; color:var(--primary-color)">${step.time}</div>
                        <div style="font-weight:700; font-size:1rem; margin-bottom:2px;">${step.action}ï¼š${item.name}</div>
                        <div style="font-size:0.85rem; color:#666; margin-bottom:2px;">${step.note}</div>
                        <div style="font-size:0.75rem; color:#999;">ğŸ“ ${address}</div>
                    </li>
                `;

                if (item.location && item.location.lng) {
                    const pt = new BMapGL.Point(item.location.lng, item.location.lat);
                    validPoints.push(pt);

                    const marker = new BMapGL.Marker(pt);
                    map.addOverlay(marker);

                    let labelTxt = (index + 1).toString();
                    if (index === 0) labelTxt = "èµ·";
                    if (index === strategy.path.length - 1) labelTxt = "ç»ˆ";

                    const label = new BMapGL.Label(labelTxt, {
                        position: pt,
                        offset: new BMapGL.Size(-8, -25)
                    });
                    label.setStyle({
                        color: "#fff", backgroundColor: "#d63031", border: "none",
                        borderRadius: "50%", padding: "2px 6px", fontSize: "12px",
                        fontWeight: "bold", fontFamily: "Arial"
                    });
                    map.addOverlay(label);
                }
            });

            if (validPoints.length > 1) {
                renderWalkingRoute(validPoints);
            }
        }

        // --- 5. æ¸²æŸ“æ­¥è¡Œå¯¼èˆª ---
        function renderWalkingRoute(points) {
            for (let i = 0; i < points.length - 1; i++) {
                const start = points[i];
                const end = points[i+1];
                const walking = new BMapGL.WalkingRoute(map, {
                    renderOptions: { map: map, autoViewport: false, enableDragging: false }
                });
                walking.search(start, end);
            }
            setTimeout(() => { map.setViewport(points); }, 500);
        }

        // --- 6. AI ç”Ÿæˆè·¯çº¿é€»è¾‘ ---
        async function generateAIRoute() {
            const prompt = document.getElementById('ai-prompt').value.trim();
            const errorDiv = document.getElementById('ai-error');
            const btn = document.getElementById('ai-btn');
            
            if(!prompt) {
                alert("è¯·å…ˆè¾“å…¥æ‚¨çš„éœ€æ±‚~");
                return;
            }

            errorDiv.style.display = 'none';
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> æ­£åœ¨æ€è€ƒä¸­...';

            try {
                // 1. æ„é€ ä¸Šä¸‹æ–‡
                const availablePois = rawDataList.map(i => ({
                    id: i.id,
                    name: i.name,
                    type: i.category || i.starOrLevel,
                    rating: i.rating
                }));

                // 2. æ„é€  System Prompt
                const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„åŒ—äº¬å¯¼æ¸¸ã€‚è¯·æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œä»ä»¥ä¸‹å¯é€‰åœ°ç‚¹ä¸­è§„åˆ’ä¸€æ¡æ¸¸è§ˆè·¯çº¿ã€‚
                å¯é€‰åœ°ç‚¹æ•°æ®ï¼š${JSON.stringify(availablePois)}
                
                è¦æ±‚ï¼š
                1. å¿…é¡»åªä½¿ç”¨â€œå¯é€‰åœ°ç‚¹æ•°æ®â€ä¸­çš„ idã€‚
                2. è¿”å›æ ¼å¼å¿…é¡»æ˜¯ä¸¥æ ¼çš„ JSONï¼Œä¸è¦åŒ…å« Markdown æ ¼å¼ã€‚
                3. JSON æ ¼å¼å¦‚ä¸‹ï¼š
                {
                    "desc": "ä¸€å¥è¯æ¦‚æ‹¬è·¯çº¿ç‰¹è‰²",
                    "path": [
                        { "id": "å¯¹åº”åœ°ç‚¹çš„id", "time": "HH:MM", "action": "åŠ¨ä½œ", "note": "æ¨èç†ç”±" }
                    ]
                }`;

                // 3. å‘èµ·è¯·æ±‚ (æ³¨æ„ï¼šå‰ç«¯ç›´æ¥è°ƒç”¨Keyä¸å®‰å…¨ï¼Œç”Ÿäº§ç¯å¢ƒè¯·åç«¯ä»£ç†)
                const response = await fetch("https://ark.cn-beijing.volces.com/api/v3/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer 5130f665-07ee-41bb-97ff-c0c615dff8c0"
                    },
                    body: JSON.stringify({
                        "model": "doubao-seed-1-6-251015",
                        "max_completion_tokens": 4096,
                        "messages": [
                            { "role": "system", "content": systemPrompt },
                            { "role": "user", "content": prompt }
                        ]
                    })
                });

                if(!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");
                const resJson = await response.json();
                
                let aiContent = resJson.choices[0].message.content;
                aiContent = aiContent.replace(/```json/g, '').replace(/```/g, '').trim();
                const routeData = JSON.parse(aiContent);

                routeStrategies['ai-custom'] = routeData;
                switchRoute('ai-custom');

            } catch (err) {
                console.error(err);
                errorDiv.innerText = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'âœ¨ ç”Ÿæˆæˆ‘çš„ä¸“å±è·¯çº¿';
            }
        }

        init();
    </script>
</body>
</html>